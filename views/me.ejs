<!DOCTYPE html>
<html>
<head>
  <title><%= title %> - Home</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#6a74f0">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <style>
@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap');
    .head {
      padding: 11px;
      position: static;
      z-index: 999;
      top: 0;
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      background-color: var(--blue);
      box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
    }
    .head .head-icon i {
      font-size: 15px !important;
      color: white;
    }
    .head .head-icon {
      display: block;
      min-width: 60px;
      line-height: 30px;
      text-align: center;
      margin-top: 5px;
      padding: 5px;
    }
    .head .title {
      color: white;
      margin: 5px;
    }
    body {
      background-color: #191c25;
      font-family: "Roboto", sans-serif !important;
    }
    .body {
      margin-top: 20px;
    }
    a.item {
      padding: 15px !important;
    }
:root {
      --blue: #6a74f0;
    }
    .message {
      font-weight: 200 !important;
      font-size: 15px;
    }
    .item .content {
      display: block;
      width: 80% !important;
    }
    .icon-bar {
      background-color: white;
      width: 25px;
      border-radius: 5px;
      margin: 5px auto;
      height: 3px;
      display: block;
      transition: all 0.3s ease;
    }
    .head-icon.active .icon-bar:first-child {
      transform: translateY(8px) rotate(45deg);
    }
    .head-icon.active .icon-bar:nth-child(2) {
      opacity: 0;
    }
    .head-icon.active .icon-bar:last-child {
      transform: translateY(-8px) rotate(-45deg);
    }
    .setting-profile {
      transform: translateX(150%);
      transition: transform 0.4s ease;
      z-index: 9999 !important;
      background-color: #191c25;
      position: absolute;
      display: none;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
    }
    .background {
      background-color: var(--blue);
    }
    .name {
      font-weight: bold !important;
      font-size: 20px !important;
    }
    .email {
      margin-top: -15px !important;
      font-size: 15px !important;
      color: #e0e2e3b2 !important;
    }
    ul {
      background-color: #e8e8e8 !important;
    }
    .navbar-profile {
      background-color: transparent;
      display: flex;
      padding-left: 20px;
      padding-right: 20px;
      box-shadow: none;
      justify-content: space-between;
    }
    .back-profile, .edit-banner {
      z-index: 99 !important;
    }
    .back-profile i,
    .edit-banner i {
      color: #fff;
      font-size: 26px;
    }
    .status {
      font-size: 15px;
      font-family: sans-serif !important;
      font-weight: 500;
    }
    .status.online::after {
      content: "Online";
      opacity: 0.7;
      color: #00fb61;
    }
    .status.offline::after {
      content: "Offline",
      opacity: 0.7;
    }
    .header-name {
      font-size: 19px;
      color: white !important;
      font-weight: 600 !important;
      font-family: "Montserrat", sans-serif !important;
    }
    .head-profile {
      background-position: 50% 50% !important;
      background-size: cover !important;
      background-repeat: no-repeat;
      height: 200px !important;
      z-index: -1 !important;
      <% if (req.user.banner !== null) {
        %>
        background: url("<%- req.user.avatar%>");
          <%
        }

        else { %>
        background: url("https://media.discordapp.net/attachments/830055801614762017/882271174715928646/IMG_20210831_213036.jpg");
        <%
      }

      %>
      color: white;
      position: relative !important;
    }
    .head-profile::after {
      content: '' !important;
      display: block !important;
      position: absolute !important;
      width: 100% !important;
      height: 35% !important;
      z-index: 99 !important;
      background-image: linear-gradient(totop,rgba(0,0,0,0.5), rgba(0,0,0,0)) !important;
      bottom: 0 !important;
    }
    .head-profile::before {
      content: '' !important;
      display: block !important;
      position: absolute !important;
      width: 100% !important;
      height: 50% !important;
      z-index: 99 !important;
      background-image: linear-gradient(tobottom,rgba(0,0,0,0.5), rgba(0,0,0,0)) !important;
      top: 0 !important;
    }
    .foto-profile {
      position: absolute;
      padding-left: 20px;
      z-index: 3;
      display: flex;
      transform: translateY(50%);
      bottom: 0 !important;
    }
    .img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      box-shadow: 0 0 4px rgba(0,0,0,0.3);
    }
    .username {
      margin-left: 10px;
      margin-top: 15px;
    }
    .username h5 {
      text-shadow: 0px 1px 1px black;
    }
    .username p {
      color: #7a7f80;
      margin-top: -7px;
    }
    .item-seting .content .header {
      margin-bottom: 5px !important;
    }
    .item-seting {
      margin-bottom: 15px;
    }
  </style>
</head>
<body>

  <div id="head" class="head">
    <a href="#" id="icon" data-target="slide-out" class="sidenav-trigger head-icon">
      <div class="icon-bar"></div>
      <div class="icon-bar"></div>
      <div class="icon-bar"></div>
    </a>
    <div class="title">
      <h4><%- title %></h4>
    </div>
  </div>

  <ul id="slide-out" class="sidenav">
    <li>
      <div class="user-view">
        <div class="background">
        </div>
        <a><img class="circle user-avatar-sidebar" src="<%- process.env.WEBURL %>/attachment/avatar/<%- req.user.id %>"></a>
        <h2><span class="white-text name"><%- req.user.displayName %></span></h2>
        <h4><span class="email"><%- req.user.email %></span></h4>
      </div>
    </li>
    <li><a class="waves-effect" onclick="showSettingModal()"><i class="material-icons">settings</i>Settings</a></li>
  </ul>

  <div class="body">
    <div class="ui massive list">
      <% list.map(x => {
        %>
        <a href="/@me/<%- x.id %>" class="waves-effect item">
          <img class="ui avatar image" src="<%- process.env.WEBURL %>/attachment/avatar/<%- x.id %>">
          <div class="content">
            <div name="<%- x.id %>" class="header header-name">
              <%- x.displayName %>
            </div>
            <p class="status status-<%- x.id.replace(/ /g, ""); %>"></p>
          </div>
        </a>
        <%
      }) %>
    </div>
  </div>
  
  <div class="setting-profile">
    <div class="head-profile">
      <nav class="navbar-profile">
        <a onclick="closeSettingModal()" class="back-profile">
          <i class="arrow left icon"></i>
        </a>
        <div class="edit-banner">
          <i class="material-icons">edit</i>
        </div>
      </nav>
      <div class="foto-profile">
        <div class="avatar">
          <img src="<%- process.env.WEBURL %>/attachment/avatar/<%- req.user.id %>" class="user-profile-avatar img">
        </div>
        <div class="username">
          <h5><%- req.user.displayName %></h5>
          <p class="status online">

          </p>
        </div>
      </div>
    </div>

    <br><br><br>
    <div style="background-color: transparent" class="ui segment">
      <div style="color: rgba(225,225,225,0.5);" class="ui large inverted relaxed list">
        <div class="item item-seting">
          <div class="content">
            <div class="header">
              @<%- req.user.displayName %>
            </div>
            Username
          </div>
        </div>
        <div onclick="triggerImage()" class="waves-effect item item-seting">
          <div class="content">
            <div class="header">
              Avatar
              <!-- <button onclick="triggerImage()">Change avatar</button>
                                                        --><input style="display: none" type="file" onchange="checkFile()" accept="image/*">
            </div>
            Tap here to change your avatar
          </div>
        </div>
        <div class="item item-seting">
          <div class="content">
            <div class="header">
              <%- req.user.info %>
            </div>
            Add some info to your account
          </div>
        </div>
        <div class="item item-seting">
          <div class="content">
            <div class="header">
              <%- req.user.email %>
            </div>
            Email
          </div>
        </div>
        <div class="item item-seting">
          <div class="content">
            <div class="header">
              <%- req.user.id %>
            </div>
            Bagikan id ini supaya teman kamu bisa chatan sama kamu
          </div>
        </div>
      </div>
    </div>

  </div>

  <script src="//cdn.jsdelivr.net/npm/eruda"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
  <script>
    eruda.init();
    const dataWEB = {
      url: "https://localhost:3000",
      port: "3000",
      path: "/@me"
    }
    // Connect to Socket io
    const socket = io();

    //check user online
    socket.on("list-user-connect", user => {
      user.forEach(x => {
        x.id = x.id.replace(/ /g, "");
        let parent = document.querySelector(`.status-${x.id}`);

        if (parent !== null) {

          parent.classList.add("online");
        }
      });
    });
    // change avatar
    socket.on("new-avatar-change", data => {
      if (data.id == "<%- req.user.id %>") {
        let sideImg = document.querySelector(".user-avatar-sidebar");
        sideImg.src = data.newAvatar;
        return;
      }
    });


    // if user disconnect
    /*socket.on("user-disconnect", user => {
      let parent = document.querySelector(`status.${user.id}`);
      if(parent) {
        if(parent.contains("online")) {
          parent.classList.remove("online");
          return parent.classList.add("offline");
        }
      }
    });*/

    function triggerImage() {
      let file = document.querySelector("input[type=file]");
      file.click();
    }
    function showSettingModal(e) {
      let setting = document.querySelector(".setting-profile");
      setting.style.display = "block";
      setTimeout(() => {
        setting.style.transform = "translateX(0%)";
      }, 400);
      return;
    }
    function closeSettingModal() {
      let setting = document.querySelector(".setting-profile");
      setting.style.transform = "translateX(150%)";
      setTimeout(() => {
        setting.style.display = "none";
      }, 500);
      return;
    }
    function checkFile() {
      const preview = document.querySelector(".user-profile-avatar");
      const file = document.querySelector('input[type=file]').files[0];
      const reader = new FileReader();
      console.log(dataWEB.url)
      reader.onloadend = function () {
        preview.src = reader.result;
        $.ajax({
          url: "/change-avatar",
          method: "post",
          data: {
            img: reader.result,
            _csrf: "<%- req.csrfToken() %>"
          },
          success: function() {
            socket.emit("trigger-avatar-change", {
              name: "<%- req.user.displayName %>",
              id: "<%- req.user.id %>",
              newAvatar: reader.result
            });
            return console.log("Avatar changed");
          },
          error: function(e) {
            return alert(JSON.stringify(e, null, 3));
          }
        })
      }

      if (file) {
        reader.readAsDataURL(file);
      } else {
        preview.src = "";
      }
    }
    /*document.getElementById("icon").addEventListener("click", () => {
    //document.getElementById("nav").classList.toggle("active");
    document.getElementById("icon").classList.toggle("active");
  });*/
    document.addEventListener('DOMContentLoaded', function() {
      const elems = document.querySelectorAll('.sidenav');
      const instances = M.Sidenav.init(elems);
    });
  </script>
</body>
</html>